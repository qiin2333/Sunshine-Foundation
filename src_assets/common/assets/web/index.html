<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
  <head>
    <%- header %>
  </head>

  <body id="app" v-cloak>
    <Navbar></Navbar>
    <div id="content" class="container">
      <h1 class="my-4">{{ $t('index.welcome') }}</h1>
      <p>{{ $t('index.description') }}</p>
      <div class="alert alert-danger" v-if="fancyLogs.find(x => x.level === 'Fatal')">
        <div style="line-height: 32px">
          <i class="fas fa-circle-exclamation" style="font-size: 32px; margin-right: 0.25em"></i>
          <p v-html="$t('index.startup_errors')"></p>
          <br />
        </div>
        <ul>
          <li v-for="v in fancyLogs.filter(x => x.level === 'Fatal')">{{v.value}}</li>
        </ul>
        <a class="btn btn-danger" href="/troubleshooting/#logs">View Logs</a>
      </div>
      <!-- Version -->
      <div class="card p-2 my-4">
        <div class="card-body" v-if="version">
          <h2>Version {{version.version}}</h2>
          <br />
          <div v-if="loading">{{ $t('index.loading_latest') }}</div>
          <div class="alert alert-success" v-if="buildVersionIsDirty">{{ $t('index.version_dirty') }} 🌇</div>
          <div class="alert alert-info" v-if="installedVersionNotStable">
            {{ $t('index.installed_version_not_stable') }}
          </div>
          <div
            v-else-if="(!preReleaseBuildAvailable || !notifyPreReleases) && !stableBuildAvailable && !buildVersionIsDirty"
          >
            <div class="alert alert-success">{{ $t('index.version_latest') }}</div>
          </div>
          <div v-if="notifyPreReleases && preReleaseBuildAvailable">
            <div class="alert alert-warning">
              <div class="d-flex justify-content-between">
                <div class="my-2">有新的 <b>基地版</b> sunshine可以更新!</div>
                <a class="btn btn-success m-1" :href="preReleaseVersion.release.html_url" target="_blank"
                  >{{ $t('index.download') }}</a
                >
              </div>
              <h3>{{preReleaseVersion.release.name}}</h3>
              <div class="markdown-content" v-html="parsedPreReleaseBody"></div>
            </div>
          </div>
          <div v-if="stableBuildAvailable">
            <div class="alert alert-warning">
              <div class="d-flex justify-content-between">
                <div class="my-2">{{ $t('index.new_stable') }}</div>
                <a class="btn btn-success m-1" :href="githubVersion.release.html_url" target="_blank"
                  >{{ $t('index.download') }}</a
                >
              </div>
              <h3>{{githubVersion.release.name}}</h3>
              <div class="markdown-content" v-html="parsedStableBody"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Resources -->
      <div class="my-4">
        <Resource-Card></Resource-Card>
      </div>
    </div>
  </body>

  <script type="module">
    import { createApp } from 'vue'
    import { initApp } from './init'
    import Navbar from './Navbar.vue'
    import ResourceCard from './ResourceCard.vue'
    import SunshineVersion from './sunshine_version'
    import { marked } from 'marked'
    import { initFirebase, trackEvents } from './firebase-config'

    console.log('Hello, Sunshine!')

    // 初始化Firebase Analytics
    const firebase = initFirebase()

    let app = createApp({
      components: {
        Navbar,
        ResourceCard,
      },
      data() {
        return {
          version: null,
          githubVersion: null,
          notifyPreReleases: false,
          preReleaseVersion: null,
          loading: true,
          logs: null,
        }
      },
      async created() {
        // 记录页面访问
        trackEvents.pageView('home')

        try {
          let config = await fetch('/api/config').then((r) => r.json())
          this.notifyPreReleases = config.notify_pre_releases
          this.version = new SunshineVersion(null, config.version)
          console.log('Version: ', this.version.version)
          this.githubVersion = new SunshineVersion(
            await fetch('https://api.github.com/repos/qiin2333/Sunshine/releases/latest').then((r) => r.json()),
            null
          )
          console.log('GitHub Version: ', this.githubVersion.version)
          this.preReleaseVersion = new SunshineVersion(
            (await fetch('https://api.github.com/repos/qiin2333/Sunshine/releases').then((r) => r.json())).find(
              (release) => release.prerelease
            ),
            null
          )
          console.log('Pre-Release Version: ', this.preReleaseVersion.version)

          // 记录版本检查事件
          if (this.githubVersion && this.version) {
            trackEvents.versionChecked(this.version.version, this.githubVersion.version)
          }
        } catch (e) {
          console.error(e)
          // 记录错误事件
          trackEvents.errorOccurred('version_check', e.message)
        }
        try {
          this.logs = await fetch('/api/logs').then((r) => r.text())
        } catch (e) {
          console.error(e)
        }
        if (this.version) document.title += ` Ver ${this.version.version}`
        this.loading = false
      },
      computed: {
        installedVersionNotStable() {
          if (!this.githubVersion || !this.version) {
            return false
          }
          return this.version.isGreater(this.githubVersion)
        },
        stableBuildAvailable() {
          if (!this.githubVersion || !this.version) {
            return false
          }
          return this.githubVersion.isGreater(this.version)
        },
        preReleaseBuildAvailable() {
          if (!this.preReleaseVersion || !this.githubVersion || !this.version) {
            return false
          }
          return this.preReleaseVersion.isGreater(this.version)
        },
        buildVersionIsDirty() {
          return this.version.version?.split('.').length === 5 && this.version.version.indexOf('dirty') !== -1
        },
        parsedStableBody() {
          if (!this.githubVersion?.release?.body) return ''
          // 预处理换行符，确保GitHub的换行符被正确解析
          const processedText = this.githubVersion.release.body
            .replace(/\r\n/g, '\n') // 统一换行符
            .replace(/\r/g, '\n') // 处理旧式换行符
          return marked(processedText, {
            breaks: true, // 启用换行符解析
            gfm: true, // 启用GitHub风格Markdown
          })
        },
        parsedPreReleaseBody() {
          if (!this.preReleaseVersion?.release?.body) return ''
          // 预处理换行符，确保GitHub的换行符被正确解析
          const processedText = this.preReleaseVersion.release.body
            .replace(/\r\n/g, '\n') // 统一换行符
            .replace(/\r/g, '\n') // 处理旧式换行符
          return marked(processedText, {
            breaks: true, // 启用换行符解析
            gfm: true, // 启用GitHub风格Markdown
          })
        },
        /** Parse the text errors, calculating the text, the timestamp and the level */
        fancyLogs() {
          if (!this.logs) return []
          let regex = /(\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}]):\s/g
          let rawLogLines = this.logs.split(regex).splice(1)
          let logLines = []
          for (let i = 0; i < rawLogLines.length; i += 2) {
            logLines.push({
              timestamp: rawLogLines[i],
              level: rawLogLines[i + 1].split(':')[0],
              value: rawLogLines[i + 1],
            })
          }
          return logLines
        },
      },
    })

    initApp(app)
  </script>

  <style>
    .markdown-content {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      padding: 16px;
      margin-top: 12px;
      line-height: 1.6;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      line-height: 1.25;
    }

    .markdown-content h1 {
      font-size: 1.5em;
    }
    .markdown-content h2 {
      font-size: 1.3em;
    }
    .markdown-content h3 {
      font-size: 1.1em;
    }

    .markdown-content p {
      margin-bottom: 12px;
      white-space: pre-line; /* 保留换行符 */
    }

    .markdown-content ul,
    .markdown-content ol {
      margin-bottom: 12px;
      padding-left: 24px;
    }

    .markdown-content li {
      margin-bottom: 4px;
    }

    .markdown-content code {
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .markdown-content pre {
      background: rgba(0, 0, 0, 0.1);
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .markdown-content pre code {
      background: none;
      padding: 0;
    }

    .markdown-content blockquote {
      border-left: 4px solid #007bff;
      margin: 12px 0;
      padding-left: 16px;
      color: #6c757d;
    }

    .markdown-content a {
      color: #007bff;
      text-decoration: none;
    }

    .markdown-content a:hover {
      text-decoration: underline;
    }

    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      text-align: left;
    }

    .markdown-content th {
      background: rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }
  </style>
</html>
